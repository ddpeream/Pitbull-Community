// i18n for Pitbull Community - Web Components + event-driven engine

const translations = {
    es: {
        // Document
        doc_title: "Pitbull Community - Educación y adopción responsable",
        doc_description: "Información amable y moderna sobre perros tipo Pitbull en Colombia. Educación, bienestar y comunidad paisa y cosmopolita.",

        // Navigation
        nav_home: "Inicio",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Comunidades",
        nav_places: "Lugares",
        nav_gallery: "Galería",

        // Hero section
        hero_title: "Conoce, cuida y adopta responsablemente",
        hero_subtitle: "Información amable y moderna sobre perros tipo Pitbull en Colombia. Educación, bienestar y comunidad paisa y cosmopolita.",
        hero_explore: "Explorar Pitbulls",
        hero_places: "Ver parches y vets",

        // Learn section
        learn_title: "¿Qué aprenderás?",
        learn_myths_title: "Mitos vs Hechos",
        learn_myths_desc: "Desmontamos prejuicios y compartimos datos reales sobre comportamiento y bienestar.",
        learn_social_title: "Socialización positiva",
        learn_social_desc: "Herramientas prácticas para paseos, juego y entrenamiento amable.",
        learn_health_title: "Salud y cuidados",
        learn_health_desc: "Vacunas, nutrición, ejercicio y señales de alerta para cuidar mejor.",

        // Featured section
        featured_title: "Destacados",
        featured_subtitle: "Una muestra de lo que encontrarás en la comunidad.",

        // Pitbulls page
        pitbulls_title: 'Explorador de Pitbulls',
        pitbulls_subtitle: 'Filtra y encuentra perros para adopción o educación. Datos de ejemplo.',
        pitbulls_search_label: 'Buscar',
        pitbulls_search_placeholder: 'Nombre, ciudad o etiqueta…',
        pitbulls_age_label: 'Edad',
        pitbulls_all_ages: 'Todas',
        pitbulls_age_puppy: 'Cachorro',
        pitbulls_age_adult: 'Adulto',
        pitbulls_age_senior: 'Senior',
        pitbulls_gender_label: 'Sexo',
        pitbulls_all_genders: 'Todos',
        pitbulls_gender_female: 'Hembra',
        pitbulls_gender_male: 'Macho',
        pitbulls_size_label: 'Tamaño',
        pitbulls_all_sizes: 'Todos',
        pitbulls_size_small: 'Pequeño',
        pitbulls_size_medium: 'Mediano',
        pitbulls_size_large: 'Grande',
        pitbulls_compatibility_label: 'Compatibilidad',
        pitbulls_any_compatibility: 'Cualquiera',
        pitbulls_compatibility_children: 'Niños',
        pitbulls_compatibility_dogs: 'Otros perros',
        pitbulls_status_label: 'Estado',
        pitbulls_all_statuses: 'Todos',
        pitbulls_status_adoption: 'Adopción',
        pitbulls_status_education: 'Educación',
        pitbulls_sort_label: 'Ordenar por',
        pitbulls_sort_recent: 'Recientes',
        pitbulls_sort_compatibility: 'Compatibilidad',
        pitbulls_load_more: 'Cargar más',
        pitbulls_no_results: 'No se encontraron resultados con esos filtros.',
        pitbulls_dog_profile: 'Ficha del perro',

        // Communities page
        communities_title: 'Refugios, Clubes y Comunidad',
        communities_subtitle: 'Busca por ciudad o enfoque. Abre el detalle para contactos.',
        communities_search_label: 'Buscar',
        communities_search_placeholder: 'Nombre, ciudad o IG…',
        communities_city_label: 'Ciudad',
        communities_all_cities: 'Todas',
        communities_focus_label: 'Enfoque',
        communities_all_focuses: 'Todos',
        communities_focus_rescue: 'Rescate',
        communities_focus_education: 'Educación',
        communities_focus_sport: 'Deporte',
        communities_no_results: 'No se encontraron comunidades.',
        communities_guides_title: 'Guías recomendadas',
        communities_guide1: 'Tenencia responsable',
        communities_guide2: 'Socialización positiva',
        communities_modal_title: 'Detalle de la comunidad',

        // Places page
        places_title: 'Parques, Vets y Tiendas',

        // Gallery page
        gallery_title: 'Galería & Historias',
        gallery_subtitle: 'Momentos felices, adopciones y comunidad.',
        gallery_filter_label: 'Filtrar por etiqueta',
        gallery_all_tags: 'Todas',
        gallery_tag_adoptions: 'Adopciones',
        gallery_tag_training: 'Entrenamiento',
        gallery_tag_community: 'Comunidad',
        featured_dogs: "Perros",
        featured_communities: "Comunidades",
        featured_places: "Lugares",

        // Newsletter
        newsletter_title: "Suscríbete a nuestro boletín",
        newsletter_email_label: "Correo electrónico",
        newsletter_email_placeholder: "tu@correo.com",
        newsletter_submit: "Quiero recibir novedades",
        newsletter_hint: "Sin spam. Puedes darte de baja en cualquier momento.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Educación y adopción responsable.",
        footer_responsible: "Tenencia responsable",
        footer_stories: "Historias",

        // Common
        loading: "Cargando...",
        error: "Error al cargar",
        no_results: "No se encontraron resultados",
        close: "Cerrar",
        search: "Buscar",
        filter: "Filtrar",
        all: "Todos",

        // Language names
        lang_spanish: "Español",
        lang_english: "English",
        lang_german: "Deutsch",
        lang_chinese: "中文"
    },

    en: {
        // Document
        doc_title: "Pitbull Community - Education and responsible adoption",
        doc_description: "Friendly and modern information about Pitbull-type dogs in Colombia. Education, welfare and paisa & cosmopolitan community.",

        // Navigation
        nav_home: "Home",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Communities",
        nav_places: "Places",
        nav_gallery: "Gallery",

        // Hero section
        hero_title: "Learn, care and adopt responsibly",
        hero_subtitle: "Friendly and modern information about Pitbull-type dogs in Colombia. Education, welfare and paisa & cosmopolitan community.",
        hero_explore: "Explore Pitbulls",
        hero_places: "See parks & vets",

        // Learn section
        learn_title: "What will you learn?",
        learn_myths_title: "Myths vs Facts",
        learn_myths_desc: "We dismantle prejudices and share real data about behavior and welfare.",
        learn_social_title: "Positive socialization",
        learn_social_desc: "Practical tools for walks, play and gentle training.",
        learn_health_title: "Health and care",
        learn_health_desc: "Vaccines, nutrition, exercise and warning signs to better care.",

        // Featured section
        featured_title: "Featured",
        featured_subtitle: "A sample of what you'll find in the community.",

        // Pitbulls page
        pitbulls_title: 'Pitbull Explorer',
        pitbulls_subtitle: 'Filter and find dogs for adoption or education. Sample data.',
        pitbulls_search_label: 'Search',
        pitbulls_search_placeholder: 'Name, city or tag…',
        pitbulls_age_label: 'Age',
        pitbulls_all_ages: 'All',
        pitbulls_age_puppy: 'Puppy',
        pitbulls_age_adult: 'Adult',
        pitbulls_age_senior: 'Senior',
        pitbulls_gender_label: 'Gender',
        pitbulls_all_genders: 'All',
        pitbulls_gender_female: 'Female',
        pitbulls_gender_male: 'Male',
        pitbulls_size_label: 'Size',
        pitbulls_all_sizes: 'All',
        pitbulls_size_small: 'Small',
        pitbulls_size_medium: 'Medium',
        pitbulls_size_large: 'Large',
        pitbulls_compatibility_label: 'Compatibility',
        pitbulls_any_compatibility: 'Any',
        pitbulls_compatibility_children: 'Children',
        pitbulls_compatibility_dogs: 'Other dogs',
        pitbulls_status_label: 'Status',
        pitbulls_all_statuses: 'All',
        pitbulls_status_adoption: 'Adoption',
        pitbulls_status_education: 'Education',
        pitbulls_sort_label: 'Sort by',
        pitbulls_sort_recent: 'Recent',
        pitbulls_sort_compatibility: 'Compatibility',
        pitbulls_load_more: 'Load more',
        pitbulls_no_results: 'No results found with those filters.',
        pitbulls_dog_profile: 'Dog Profile',

        // Communities page
        communities_title: 'Shelters, Clubs and Community',
        communities_subtitle: 'Search by city or focus. Open details for contacts.',
        communities_search_label: 'Search',
        communities_search_placeholder: 'Name, city or IG…',
        communities_city_label: 'City',
        communities_all_cities: 'All',
        communities_focus_label: 'Focus',
        communities_all_focuses: 'All',
        communities_focus_rescue: 'Rescue',
        communities_focus_education: 'Education',
        communities_focus_sport: 'Sport',
        communities_no_results: 'No communities found.',
        communities_guides_title: 'Recommended Guides',
        communities_guide1: 'Responsible ownership',
        communities_guide2: 'Positive socialization',
        communities_modal_title: 'Community Details',

        // Places page
        places_title: 'Parks, Vets and Stores',

        // Gallery page
        gallery_title: 'Gallery & Stories',
        gallery_subtitle: 'Happy moments, adoptions and community.',
        gallery_filter_label: 'Filter by tag',
        gallery_all_tags: 'All',
        gallery_tag_adoptions: 'Adoptions',
        gallery_tag_training: 'Training',
        gallery_tag_community: 'Community',
        featured_dogs: "Dogs",
        featured_communities: "Communities",
        featured_places: "Places",

        // Newsletter
        newsletter_title: "Subscribe to our newsletter",
        newsletter_email_label: "Email",
        newsletter_email_placeholder: "your@email.com",
        newsletter_submit: "I want to receive news",
        newsletter_hint: "No spam. You can unsubscribe at any time.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Education and responsible adoption.",
        footer_responsible: "Responsible ownership",
        footer_stories: "Stories",

        // Common
        loading: "Loading...",
        error: "Error loading",
        no_results: "No results found",
        close: "Close",
        search: "Search",
        filter: "Filter",
        all: "All",

        // Language names
        lang_spanish: "Spanish",
        lang_english: "English",
        lang_german: "German",
        lang_chinese: "Chinese"
    },

    de: {
        // Document
        doc_title: "Pitbull Community - Bildung und verantwortliche Adoption",
        doc_description: "Freundliche und moderne Informationen über Pitbull-Hunde in Kolumbien. Bildung, Wohlfahrt und paisa & kosmopolitische Gemeinschaft.",

        // Navigation
        nav_home: "Startseite",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Gemeinschaften",
        nav_places: "Orte",
        nav_gallery: "Galerie",

        // Hero section
        hero_title: "Lernen, pflegen und verantwortlich adoptieren",
        hero_subtitle: "Freundliche und moderne Informationen über Pitbull-Hunde in Kolumbien. Bildung, Wohlfahrt und paisa & kosmopolitische Gemeinschaft.",
        hero_explore: "Pitbulls erkunden",
        hero_places: "Parks & Tierärzte ansehen",

        // Learn section
        learn_title: "Was wirst du lernen?",
        learn_myths_title: "Mythen vs Fakten",
        learn_myths_desc: "Wir bauen Vorurteile ab und teilen echte Daten über Verhalten und Wohlbefinden.",
        learn_social_title: "Positive Sozialisierung",
        learn_social_desc: "Praktische Werkzeuge für Spaziergänge, Spiel und sanftes Training.",
        learn_health_title: "Gesundheit und Pflege",
        learn_health_desc: "Impfungen, Ernährung, Bewegung und Warnzeichen für bessere Pflege.",

        // Featured section
        featured_title: "Empfohlen",
        featured_subtitle: "Eine Auswahl dessen, was Sie in der Gemeinschaft finden werden.",

        // Pitbulls page
        pitbulls_title: 'Pitbull-Explorer',
        pitbulls_subtitle: 'Filtern und finden Sie Hunde für Adoption oder Bildung. Beispieldaten.',
        pitbulls_search_label: 'Suchen',
        pitbulls_search_placeholder: 'Name, Stadt oder Tag…',
        pitbulls_age_label: 'Alter',
        pitbulls_all_ages: 'Alle',
        pitbulls_age_puppy: 'Welpe',
        pitbulls_age_adult: 'Erwachsen',
        pitbulls_age_senior: 'Senior',
        pitbulls_gender_label: 'Geschlecht',
        pitbulls_all_genders: 'Alle',
        pitbulls_gender_female: 'Weiblich',
        pitbulls_gender_male: 'Männlich',
        pitbulls_size_label: 'Größe',
        pitbulls_all_sizes: 'Alle',
        pitbulls_size_small: 'Klein',
        pitbulls_size_medium: 'Mittel',
        pitbulls_size_large: 'Groß',
        pitbulls_compatibility_label: 'Kompatibilität',
        pitbulls_any_compatibility: 'Jede',
        pitbulls_compatibility_children: 'Kinder',
        pitbulls_compatibility_dogs: 'Andere Hunde',
        pitbulls_status_label: 'Status',
        pitbulls_all_statuses: 'Alle',
        pitbulls_status_adoption: 'Adoption',
        pitbulls_status_education: 'Bildung',
        pitbulls_sort_label: 'Sortieren nach',
        pitbulls_sort_recent: 'Aktuell',
        pitbulls_sort_compatibility: 'Kompatibilität',
        pitbulls_load_more: 'Mehr laden',
        pitbulls_no_results: 'Keine Ergebnisse mit diesen Filtern gefunden.',
        pitbulls_dog_profile: 'Hundeprofil',

        // Communities page
        communities_title: 'Tierheime, Clubs und Gemeinschaft',
        communities_subtitle: 'Suche nach Stadt oder Schwerpunkt. Details für Kontakte öffnen.',
        communities_search_label: 'Suchen',
        communities_search_placeholder: 'Name, Stadt oder IG…',
        communities_city_label: 'Stadt',
        communities_all_cities: 'Alle',
        communities_focus_label: 'Schwerpunkt',
        communities_all_focuses: 'Alle',
        communities_focus_rescue: 'Rettung',
        communities_focus_education: 'Bildung',
        communities_focus_sport: 'Sport',
        communities_no_results: 'Keine Gemeinschaften gefunden.',
        communities_guides_title: 'Empfohlene Leitfäden',
        communities_guide1: 'Verantwortliche Haltung',
        communities_guide2: 'Positive Sozialisation',
        communities_modal_title: 'Gemeinschaftsdetails',

        // Places page
        places_title: 'Parks, Tierärzte und Geschäfte',

        // Gallery page
        gallery_title: 'Galerie & Geschichten',
        gallery_subtitle: 'Glückliche Momente, Adoptionen und Gemeinschaft.',
        gallery_filter_label: 'Nach Tag filtern',
        gallery_all_tags: 'Alle',
        gallery_tag_adoptions: 'Adoptionen',
        gallery_tag_training: 'Training',
        gallery_tag_community: 'Gemeinschaft',
        featured_dogs: "Hunde",
        featured_communities: "Gemeinschaften",
        featured_places: "Orte",

        // Newsletter
        newsletter_title: "Abonnieren Sie unseren Newsletter",
        newsletter_email_label: "E-Mail",
        newsletter_email_placeholder: "ihre@email.com",
        newsletter_submit: "Ich möchte Neuigkeiten erhalten",
        newsletter_hint: "Kein Spam. Sie können sich jederzeit abmelden.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Bildung und verantwortliche Adoption.",
        footer_responsible: "Verantwortliches Eigentum",
        footer_stories: "Geschichten",

        // Common
        loading: "Laden...",
        error: "Fehler beim Laden",
        no_results: "Keine Ergebnisse gefunden",
        close: "Schließen",
        search: "Suchen",
        filter: "Filter",
        all: "Alle",

        // Language names
        lang_spanish: "Spanisch",
        lang_english: "Englisch",
        lang_german: "Deutsch",
        lang_chinese: "Chinesisch"
    },

    zh: {
        // Document
        doc_title: "比特犬社区 - 教育和负责任的收养",
        doc_description: "关于哥伦比亚比特犬类型犬只的友好和现代信息。教育、福利和帕伊萨与世界性社区。",

        // Navigation
        nav_home: "首页",
        nav_pitbulls: "比特犬",
        nav_communities: "社区",
        nav_places: "地点",
        nav_gallery: "画廊",

        // Hero section
        hero_title: "学习、关爱和负责任的收养",
        hero_subtitle: "关于哥伦比亚比特犬类型犬只的友好和现代信息。教育、福利和帕伊萨与世界性社区。",
        hero_explore: "探索比特犬",
        hero_places: "查看公园和兽医",

        // Learn section
        learn_title: "你将学到什么？",
        learn_myths_title: "神话与事实",
        learn_myths_desc: "我们消除偏见，分享关于行为和福利的真实数据。",
        learn_social_title: "积极社交",
        learn_social_desc: "散步、游戏和温和训练的实用工具。",
        learn_health_title: "健康和护理",
        learn_health_desc: "疫苗、营养、运动和警告信号，以便更好地护理。",

        // Featured section
        featured_title: "精选",
        featured_subtitle: "社区中你会发现的内容样本。",

        // Pitbulls page
        pitbulls_title: '比特犬探索器',
        pitbulls_subtitle: '篩選並尋找收養或教育用犬。示例資料。',
        pitbulls_search_label: '搜尋',
        pitbulls_search_placeholder: '名稱、城市或標籤…',
        pitbulls_age_label: '年齡',
        pitbulls_all_ages: '全部',
        pitbulls_age_puppy: '幼犬',
        pitbulls_age_adult: '成年',
        pitbulls_age_senior: '老年',
        pitbulls_gender_label: '性別',
        pitbulls_all_genders: '全部',
        pitbulls_gender_female: '母',
        pitbulls_gender_male: '公',
        pitbulls_size_label: '大小',
        pitbulls_all_sizes: '全部',
        pitbulls_size_small: '小型',
        pitbulls_size_medium: '中型',
        pitbulls_size_large: '大型',
        pitbulls_compatibility_label: '相容性',
        pitbulls_any_compatibility: '任何',
        pitbulls_compatibility_children: '兒童',
        pitbulls_compatibility_dogs: '其他狗',
        pitbulls_status_label: '狀態',
        pitbulls_all_statuses: '全部',
        pitbulls_status_adoption: '收養',
        pitbulls_status_education: '教育',
        pitbulls_sort_label: '排序',
        pitbulls_sort_recent: '最新',
        pitbulls_sort_compatibility: '相容性',
        pitbulls_load_more: '載入更多',
        pitbulls_no_results: '使用這些篩選條件未找到結果。',
        pitbulls_dog_profile: '狗狗檔案',

        // Communities page
        communities_title: '庇護所、俱樂部和社區',
        communities_subtitle: '按城市或重點搜尋。開啟詳情以獲取聯繫方式。',
        communities_search_label: '搜尋',
        communities_search_placeholder: '名稱、城市或IG…',
        communities_city_label: '城市',
        communities_all_cities: '全部',
        communities_focus_label: '重點',
        communities_all_focuses: '全部',
        communities_focus_rescue: '救援',
        communities_focus_education: '教育',
        communities_focus_sport: '運動',
        communities_no_results: '未找到社區。',
        communities_guides_title: '推薦指南',
        communities_guide1: '負責任的飼養',
        communities_guide2: '積極社交化',
        communities_modal_title: '社區詳情',

        // Places page
        places_title: '公園、獸醫和商店',

        // Gallery page
        gallery_title: '畫廊與故事',
        gallery_subtitle: '快樂時光、收養和社區。',
        gallery_filter_label: '按標籤篩選',
        gallery_all_tags: '全部',
        gallery_tag_adoptions: '收養',
        gallery_tag_training: '訓練',
        gallery_tag_community: '社區',
        featured_dogs: "狗",
        featured_communities: "社区",
        featured_places: "地点",

        // Newsletter
        newsletter_title: "订阅我们的通讯",
        newsletter_email_label: "邮箱",
        newsletter_email_placeholder: "your@email.com",
        newsletter_submit: "我想接收新闻",
        newsletter_hint: "无垃圾邮件。您可以随时取消订阅。",

        // Footer
        footer_text: "© 2025 比特犬社区 — 教育和负责任的收养。",
        footer_responsible: "负责任的拥有",
        footer_stories: "故事",

        // Common
        loading: "加载中...",
        error: "加载错误",
        no_results: "未找到结果",
        close: "关闭",
        search: "搜索",
        filter: "过滤",
        all: "全部",

        // Language names
        lang_spanish: "西班牙语",
        lang_english: "英语",
        lang_german: "德语",
        lang_chinese: "中文"
    }
};

// Event-driven i18n engine + Web Components
let currentLanguage = 'es';

function t(key) {
    const dict = translations[currentLanguage] || translations.es;
    return dict[key] ?? translations.es[key] ?? '';
}

function updateMetaForLang(lang) {
    const d = translations[lang] || translations.es;
    if (d.doc_title) document.title = d.doc_title;
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc && d.doc_description) metaDesc.setAttribute('content', d.doc_description);
    document.documentElement.setAttribute('lang', lang);
}

function dispatchLangChange(lang) {
    document.dispatchEvent(new CustomEvent('i18n:lang-changed', { detail: { lang } }));
}

class TText extends HTMLElement {
    static get observedAttributes() { return ['key']; }
    connectedCallback() {
        this._onLang = () => this._render();
        document.addEventListener('i18n:lang-changed', this._onLang);
        this._render();
    }
    disconnectedCallback() {
        document.removeEventListener('i18n:lang-changed', this._onLang);
    }
    attributeChangedCallback() { this._render(); }
    _render() {
        const k = this.getAttribute('key');
        if (!k) return;
        const val = t(k);
        if (typeof val === 'string' && val.includes('<')) this.innerHTML = val; else this.textContent = val;
    }
}

class TAttr extends HTMLElement {
    static get observedAttributes() { return ['for', 'attr', 'key']; }
    connectedCallback() {
        this.style.display = 'none';
        this._onLang = () => this._apply();
        document.addEventListener('i18n:lang-changed', this._onLang);
        this._apply();
    }
    disconnectedCallback() {
        document.removeEventListener('i18n:lang-changed', this._onLang);
    }
    attributeChangedCallback() { this._apply(); }
    _apply() {
        const sel = this.getAttribute('for');
        const attr = this.getAttribute('attr');
        const key = this.getAttribute('key');
        if (!sel || !attr || !key) return;
        const el = document.querySelector(sel);
        if (!el) return;
        const val = t(key);
        if (val != null) el.setAttribute(attr, val);
    }
}

customElements.define('t-text', TText);
customElements.define('t-attr', TAttr);

function changeLanguage(lang) {
    try { console.debug('[i18n] changeLanguage ->', lang); } catch {}
    currentLanguage = lang;
    sessionStorage.setItem('preferredLanguage', lang);
    updateMetaForLang(lang);
    
    // Update active state in UI
    document.querySelectorAll('.lang-btn').forEach((btn) => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`[data-lang="${lang}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // Update language selector
    const langSelect = document.querySelector('#language-selector');
    if (langSelect) langSelect.value = lang;
    
    dispatchLangChange(lang);
    
    // Fallback manual hydration
    hydrateAll();
    
    const langDropdown = document.querySelector('.lang-dropdown');
    if (langDropdown) langDropdown.classList.remove('active');
}

// Expose immediately for onclick in HTML
window.changeLanguage = changeLanguage;

function hydrateAll() {
    // Hydrate <t-text>
    document.querySelectorAll('t-text').forEach((el) => {
        const k = el.getAttribute('key');
        if (!k) return;
        const val = t(k);
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    // Hydrate <t-attr>
    document.querySelectorAll('t-attr').forEach((el) => {
        const sel = el.getAttribute('for');
        const attr = el.getAttribute('attr');
        const key = el.getAttribute('key');
        if (!sel || !attr || !key) return;
        const target = document.querySelector(sel);
        if (!target) return;
        const val = t(key);
        if (val != null) target.setAttribute(attr, val);
    });

    // Compatibility: data-translate
    document.querySelectorAll('[data-translate]').forEach((el) => {
        const key = el.getAttribute('data-translate');
        if (!key) return;
        const val = t(key);
        if (val == null) return;
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    // data-i18n compatibility
    document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const val = t(key);
        if (val == null) return;
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    document.querySelectorAll('[data-translate-alt]').forEach((el) => {
        const key = el.getAttribute('data-translate-alt');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('alt', val);
    });
    
    document.querySelectorAll('[data-translate-title]').forEach((el) => {
        const key = el.getAttribute('data-translate-title');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('title', val);
    });
    
    document.querySelectorAll('[data-translate-aria]').forEach((el) => {
        const key = el.getAttribute('data-translate-aria');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('aria-label', val);
    });
    
    document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        const val = t(key);
        if (val != null) el.placeholder = val;
    });
}

window.addEventListener('DOMContentLoaded', () => {
    try { console.debug('[i18n] DOMContentLoaded'); } catch {}
    const saved = sessionStorage.getItem('preferredLanguage') || 'es';
    currentLanguage = saved;
    updateMetaForLang(saved);
    dispatchLangChange(saved);
    
    // Update language selector
    const langSelect = document.querySelector('#language-selector');
    if (langSelect) langSelect.value = saved;
    
    // Hydrate in case browser doesn't react to Custom Elements
    hydrateAll();
    
    // Click delegation in case inline onclick are blocked
    document.addEventListener('click', (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('.lang-btn') : null;
        if (btn) {
            const lang = btn.getAttribute('data-lang');
            if (lang) changeLanguage(lang);
        }
    });
});
