// i18n for Pitbull Community - Web Components + event-driven engine

const translations = {
    es: {
        // Document
        doc_title: "Pitbull Community - Educación y adopción responsable",
        doc_description: "Información amable y moderna sobre perros tipo Pitbull en Colombia. Educación, bienestar y comunidad paisa y cosmopolita.",

        // Navigation
        nav_home: "Inicio",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Comunidades",
        nav_places: "Lugares",
        nav_gallery: "Galería",

        // Hero section
        hero_title: "Conoce, cuida y adopta responsablemente",
        hero_subtitle: "Información amable y moderna sobre perros tipo Pitbull en Colombia. Educación, bienestar y comunidad paisa y cosmopolita.",
        hero_explore: "Explorar Pitbulls",
        hero_places: "Ver parches y vets",

        // Learn section
        learn_title: "¿Qué aprenderás?",
        learn_myths_title: "Mitos vs Hechos",
        learn_myths_desc: "Desmontamos prejuicios y compartimos datos reales sobre comportamiento y bienestar.",
        learn_social_title: "Socialización positiva",
        learn_social_desc: "Herramientas prácticas para paseos, juego y entrenamiento amable.",
        learn_health_title: "Salud y cuidados",
        learn_health_desc: "Vacunas, nutrición, ejercicio y señales de alerta para cuidar mejor.",

        // Featured section
        featured_title: "Destacados",
        featured_subtitle: "Una muestra de lo que encontrarás en la comunidad.",
        featured_dogs: "Perros",
        featured_communities: "Comunidades",
        featured_places: "Lugares",

        // Newsletter
        newsletter_title: "Suscríbete a nuestro boletín",
        newsletter_email_label: "Correo electrónico",
        newsletter_email_placeholder: "tu@correo.com",
        newsletter_submit: "Quiero recibir novedades",
        newsletter_hint: "Sin spam. Puedes darte de baja en cualquier momento.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Educación y adopción responsable.",
        footer_responsible: "Tenencia responsable",
        footer_stories: "Historias",

        // Common
        loading: "Cargando...",
        error: "Error al cargar",
        no_results: "No se encontraron resultados",
        close: "Cerrar",
        search: "Buscar",
        filter: "Filtrar",
        all: "Todos",

        // Language names
        lang_spanish: "Español",
        lang_english: "English",
        lang_german: "Deutsch",
        lang_chinese: "中文"
    },

    en: {
        // Document
        doc_title: "Pitbull Community - Education and responsible adoption",
        doc_description: "Friendly and modern information about Pitbull-type dogs in Colombia. Education, welfare and paisa & cosmopolitan community.",

        // Navigation
        nav_home: "Home",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Communities",
        nav_places: "Places",
        nav_gallery: "Gallery",

        // Hero section
        hero_title: "Learn, care and adopt responsibly",
        hero_subtitle: "Friendly and modern information about Pitbull-type dogs in Colombia. Education, welfare and paisa & cosmopolitan community.",
        hero_explore: "Explore Pitbulls",
        hero_places: "See parks & vets",

        // Learn section
        learn_title: "What will you learn?",
        learn_myths_title: "Myths vs Facts",
        learn_myths_desc: "We dismantle prejudices and share real data about behavior and welfare.",
        learn_social_title: "Positive socialization",
        learn_social_desc: "Practical tools for walks, play and gentle training.",
        learn_health_title: "Health and care",
        learn_health_desc: "Vaccines, nutrition, exercise and warning signs to better care.",

        // Featured section
        featured_title: "Featured",
        featured_subtitle: "A sample of what you'll find in the community.",
        featured_dogs: "Dogs",
        featured_communities: "Communities",
        featured_places: "Places",

        // Newsletter
        newsletter_title: "Subscribe to our newsletter",
        newsletter_email_label: "Email",
        newsletter_email_placeholder: "your@email.com",
        newsletter_submit: "I want to receive news",
        newsletter_hint: "No spam. You can unsubscribe at any time.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Education and responsible adoption.",
        footer_responsible: "Responsible ownership",
        footer_stories: "Stories",

        // Common
        loading: "Loading...",
        error: "Error loading",
        no_results: "No results found",
        close: "Close",
        search: "Search",
        filter: "Filter",
        all: "All",

        // Language names
        lang_spanish: "Spanish",
        lang_english: "English",
        lang_german: "German",
        lang_chinese: "Chinese"
    },

    de: {
        // Document
        doc_title: "Pitbull Community - Bildung und verantwortliche Adoption",
        doc_description: "Freundliche und moderne Informationen über Pitbull-Hunde in Kolumbien. Bildung, Wohlfahrt und paisa & kosmopolitische Gemeinschaft.",

        // Navigation
        nav_home: "Startseite",
        nav_pitbulls: "Pitbulls",
        nav_communities: "Gemeinschaften",
        nav_places: "Orte",
        nav_gallery: "Galerie",

        // Hero section
        hero_title: "Lernen, pflegen und verantwortlich adoptieren",
        hero_subtitle: "Freundliche und moderne Informationen über Pitbull-Hunde in Kolumbien. Bildung, Wohlfahrt und paisa & kosmopolitische Gemeinschaft.",
        hero_explore: "Pitbulls erkunden",
        hero_places: "Parks & Tierärzte ansehen",

        // Learn section
        learn_title: "Was wirst du lernen?",
        learn_myths_title: "Mythen vs Fakten",
        learn_myths_desc: "Wir bauen Vorurteile ab und teilen echte Daten über Verhalten und Wohlbefinden.",
        learn_social_title: "Positive Sozialisierung",
        learn_social_desc: "Praktische Werkzeuge für Spaziergänge, Spiel und sanftes Training.",
        learn_health_title: "Gesundheit und Pflege",
        learn_health_desc: "Impfungen, Ernährung, Bewegung und Warnzeichen für bessere Pflege.",

        // Featured section
        featured_title: "Empfohlen",
        featured_subtitle: "Eine Auswahl dessen, was Sie in der Gemeinschaft finden werden.",
        featured_dogs: "Hunde",
        featured_communities: "Gemeinschaften",
        featured_places: "Orte",

        // Newsletter
        newsletter_title: "Abonnieren Sie unseren Newsletter",
        newsletter_email_label: "E-Mail",
        newsletter_email_placeholder: "ihre@email.com",
        newsletter_submit: "Ich möchte Neuigkeiten erhalten",
        newsletter_hint: "Kein Spam. Sie können sich jederzeit abmelden.",

        // Footer
        footer_text: "© 2025 Pitbull Community — Bildung und verantwortliche Adoption.",
        footer_responsible: "Verantwortliches Eigentum",
        footer_stories: "Geschichten",

        // Common
        loading: "Laden...",
        error: "Fehler beim Laden",
        no_results: "Keine Ergebnisse gefunden",
        close: "Schließen",
        search: "Suchen",
        filter: "Filter",
        all: "Alle",

        // Language names
        lang_spanish: "Spanisch",
        lang_english: "Englisch",
        lang_german: "Deutsch",
        lang_chinese: "Chinesisch"
    },

    zh: {
        // Document
        doc_title: "比特犬社区 - 教育和负责任的收养",
        doc_description: "关于哥伦比亚比特犬类型犬只的友好和现代信息。教育、福利和帕伊萨与世界性社区。",

        // Navigation
        nav_home: "首页",
        nav_pitbulls: "比特犬",
        nav_communities: "社区",
        nav_places: "地点",
        nav_gallery: "画廊",

        // Hero section
        hero_title: "学习、关爱和负责任的收养",
        hero_subtitle: "关于哥伦比亚比特犬类型犬只的友好和现代信息。教育、福利和帕伊萨与世界性社区。",
        hero_explore: "探索比特犬",
        hero_places: "查看公园和兽医",

        // Learn section
        learn_title: "你将学到什么？",
        learn_myths_title: "神话与事实",
        learn_myths_desc: "我们消除偏见，分享关于行为和福利的真实数据。",
        learn_social_title: "积极社交",
        learn_social_desc: "散步、游戏和温和训练的实用工具。",
        learn_health_title: "健康和护理",
        learn_health_desc: "疫苗、营养、运动和警告信号，以便更好地护理。",

        // Featured section
        featured_title: "精选",
        featured_subtitle: "社区中你会发现的内容样本。",
        featured_dogs: "狗",
        featured_communities: "社区",
        featured_places: "地点",

        // Newsletter
        newsletter_title: "订阅我们的通讯",
        newsletter_email_label: "邮箱",
        newsletter_email_placeholder: "your@email.com",
        newsletter_submit: "我想接收新闻",
        newsletter_hint: "无垃圾邮件。您可以随时取消订阅。",

        // Footer
        footer_text: "© 2025 比特犬社区 — 教育和负责任的收养。",
        footer_responsible: "负责任的拥有",
        footer_stories: "故事",

        // Common
        loading: "加载中...",
        error: "加载错误",
        no_results: "未找到结果",
        close: "关闭",
        search: "搜索",
        filter: "过滤",
        all: "全部",

        // Language names
        lang_spanish: "西班牙语",
        lang_english: "英语",
        lang_german: "德语",
        lang_chinese: "中文"
    }
};

// Event-driven i18n engine + Web Components
let currentLanguage = 'es';

function t(key) {
    const dict = translations[currentLanguage] || translations.es;
    return dict[key] ?? translations.es[key] ?? '';
}

function updateMetaForLang(lang) {
    const d = translations[lang] || translations.es;
    if (d.doc_title) document.title = d.doc_title;
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc && d.doc_description) metaDesc.setAttribute('content', d.doc_description);
    document.documentElement.setAttribute('lang', lang);
}

function dispatchLangChange(lang) {
    document.dispatchEvent(new CustomEvent('i18n:lang-changed', { detail: { lang } }));
}

class TText extends HTMLElement {
    static get observedAttributes() { return ['key']; }
    connectedCallback() {
        this._onLang = () => this._render();
        document.addEventListener('i18n:lang-changed', this._onLang);
        this._render();
    }
    disconnectedCallback() {
        document.removeEventListener('i18n:lang-changed', this._onLang);
    }
    attributeChangedCallback() { this._render(); }
    _render() {
        const k = this.getAttribute('key');
        if (!k) return;
        const val = t(k);
        if (typeof val === 'string' && val.includes('<')) this.innerHTML = val; else this.textContent = val;
    }
}

class TAttr extends HTMLElement {
    static get observedAttributes() { return ['for', 'attr', 'key']; }
    connectedCallback() {
        this.style.display = 'none';
        this._onLang = () => this._apply();
        document.addEventListener('i18n:lang-changed', this._onLang);
        this._apply();
    }
    disconnectedCallback() {
        document.removeEventListener('i18n:lang-changed', this._onLang);
    }
    attributeChangedCallback() { this._apply(); }
    _apply() {
        const sel = this.getAttribute('for');
        const attr = this.getAttribute('attr');
        const key = this.getAttribute('key');
        if (!sel || !attr || !key) return;
        const el = document.querySelector(sel);
        if (!el) return;
        const val = t(key);
        if (val != null) el.setAttribute(attr, val);
    }
}

customElements.define('t-text', TText);
customElements.define('t-attr', TAttr);

function changeLanguage(lang) {
    try { console.debug('[i18n] changeLanguage ->', lang); } catch {}
    currentLanguage = lang;
    sessionStorage.setItem('preferredLanguage', lang);
    updateMetaForLang(lang);
    
    // Update active state in UI
    document.querySelectorAll('.lang-btn').forEach((btn) => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`[data-lang="${lang}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // Update language selector
    const langSelect = document.querySelector('#language-selector');
    if (langSelect) langSelect.value = lang;
    
    dispatchLangChange(lang);
    
    // Fallback manual hydration
    hydrateAll();
    
    const langDropdown = document.querySelector('.lang-dropdown');
    if (langDropdown) langDropdown.classList.remove('active');
}

// Expose immediately for onclick in HTML
window.changeLanguage = changeLanguage;

function hydrateAll() {
    // Hydrate <t-text>
    document.querySelectorAll('t-text').forEach((el) => {
        const k = el.getAttribute('key');
        if (!k) return;
        const val = t(k);
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    // Hydrate <t-attr>
    document.querySelectorAll('t-attr').forEach((el) => {
        const sel = el.getAttribute('for');
        const attr = el.getAttribute('attr');
        const key = el.getAttribute('key');
        if (!sel || !attr || !key) return;
        const target = document.querySelector(sel);
        if (!target) return;
        const val = t(key);
        if (val != null) target.setAttribute(attr, val);
    });

    // Compatibility: data-translate
    document.querySelectorAll('[data-translate]').forEach((el) => {
        const key = el.getAttribute('data-translate');
        if (!key) return;
        const val = t(key);
        if (val == null) return;
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    // data-i18n compatibility
    document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const val = t(key);
        if (val == null) return;
        if (typeof val === 'string' && val.includes('<')) el.innerHTML = val; else el.textContent = val;
    });
    
    document.querySelectorAll('[data-translate-alt]').forEach((el) => {
        const key = el.getAttribute('data-translate-alt');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('alt', val);
    });
    
    document.querySelectorAll('[data-translate-title]').forEach((el) => {
        const key = el.getAttribute('data-translate-title');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('title', val);
    });
    
    document.querySelectorAll('[data-translate-aria]').forEach((el) => {
        const key = el.getAttribute('data-translate-aria');
        if (!key) return;
        const val = t(key);
        if (val != null) el.setAttribute('aria-label', val);
    });
    
    document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        const val = t(key);
        if (val != null) el.placeholder = val;
    });
}

window.addEventListener('DOMContentLoaded', () => {
    try { console.debug('[i18n] DOMContentLoaded'); } catch {}
    const saved = sessionStorage.getItem('preferredLanguage') || 'es';
    currentLanguage = saved;
    updateMetaForLang(saved);
    dispatchLangChange(saved);
    
    // Update language selector
    const langSelect = document.querySelector('#language-selector');
    if (langSelect) langSelect.value = saved;
    
    // Hydrate in case browser doesn't react to Custom Elements
    hydrateAll();
    
    // Click delegation in case inline onclick are blocked
    document.addEventListener('click', (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('.lang-btn') : null;
        if (btn) {
            const lang = btn.getAttribute('data-lang');
            if (lang) changeLanguage(lang);
        }
    });
});
